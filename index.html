<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prolanis App - Manajemen Kunjungan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* =================================================================
           BASE STYLES & VARIABLE THEME
           ================================================================= */
        :root {
            --primary-color: #3b82f6; /* Blue */
            --secondary-color: #10b981; /* Green */
            --danger-color: #ef4444; /* Red */
            --whatsapp-color: #25d366; /* WhatsApp Green */
            --text-color: #333;
            --bg-color: #f3f4f6;
            --bg-color-secondary: #ffffff;
            --border-color: #d1d5db;
        }

        body.dark-mode {
            --text-color: #f3f4f6;
            --bg-color: #1f2937;
            --bg-color-secondary: #374151;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* UTILITY */
        .mr-2 { margin-right: 0.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .p-0 { padding: 0 !important; }
        .text-3xl { font-size: 1.875rem; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .w-auto { width: auto; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-end { justify-content: flex-end; }
        .gap-4 { gap: 1rem; }
        .gap-3 { gap: 0.75rem; }

        /* BASE LAYOUT */
        #app-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .top-bar-info {
            background-color: #008cff;
            color: #fcfcfc;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color-secondary);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .navbar h1 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin: 0;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .navbar-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .main-container {
            padding: 20px 0;
        }

        .content-section {
            display: none;
            padding: 25px;
            background-color: var(--bg-color-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .content-section.active {
            display: block;
        }
        
        .card {
            padding: 25px;
            background-color: var(--bg-color-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-top: 25px;
            border: 1px solid var(--border-color);
        }

        /* FORM STYLES */
        fieldset {
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        fieldset:hover {
            border-color: var(--primary-color);
        }

        legend {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            padding: 0 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .form-group input:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* BUTTONS */
        .btn-base {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-submit:hover {
            background-color: #2563eb;
        }

        .btn-cancel {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-cancel:hover {
            background-color: #9ca3af;
        }

        .btn-delete-pasien, .btn-delete {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-delete-pasien:hover, .btn-delete:hover {
            background-color: #b91c1c;
        }
        
        .btn-whatsapp {
            background-color: var(--whatsapp-color);
            color: white;
        }
        .btn-whatsapp:hover {
            background-color: #1eaf53;
        }

        .btn-riwayat {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-riwayat:hover {
            background-color: #047857;
        }

        .btn-detail {
            background-color: var(--primary-color);
            color: white;
        }

        /* SEARCH/AUTOCOMPLETE */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-color-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .search-item:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        
        .search-item-info {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .dashboard-card h4 {
            font-size: 1rem;
            margin: 5px 0;
            font-weight: 500;
        }

        .dashboard-card p {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        /* TABLE STYLES */
        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .data-table th {
            background-color: var(--bg-color);
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
        }

        .data-table tbody tr:hover {
            background-color: var(--bg-color);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .flex.gap-2 {
            display: flex;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .btn-aksi {
            padding: 8px 10px;
            font-size: 0.8rem;
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            /* Pastikan display:none di JS saat initialize */
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--bg-color-secondary);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal-actions, .modal-confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .status-success {
            background-color: #d1fae5; color: #065f46; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;
        }
        .status-error {
            background-color: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;
        }
        .status-info {
            background-color: #dbeafe; color: #1e40af; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;
        }
        .status-warning {
            background-color: #fef08a; color: #a16207; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;
        }
        
        #status-message {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.5s ease-out;
        }

        /* LOADING */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--bg-color-secondary-rgb, 255, 255, 255), 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            display: none;
        }

        .loading-box {
            background-color: var(--bg-color-secondary);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .loader {
            border: 6px solid var(--border-color);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    
    <div id="app-container">
        
        <div class="top-bar-info">
            <i class="fas fa-bullhorn mr-2"></i> Aplikasi Manajemen Prolanis - Data tersimpan **lokal di perangkat Anda** (Hanya di komputer Utama).
        </div>

        <div class="navbar">
            <div class="navbar-left">
                <h1>
                    <i class="fas fa-heartbeat"></i> Prolanis App
                </h1>
                <div class="navbar-links">
                    <a href="#" class="nav-link" data-section="dashboard-section"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="#" class="nav-link active" data-section="input-form-area"><i class="fas fa-plus-circle"></i> Input Baru</a>
                    <a href="#" class="nav-link" data-section="rekapan-section">
                        <i class="fas fa-chart-line"></i> Rekapan Kunjungan
                    </a>
                    <a href="#" class="nav-link" data-section="daftar-section">
                        <i class="fas fa-user-friends"></i> Daftar Pasien
                    </a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <label class="theme-switch" title="Toggle Dark/Light Mode" style="cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-color);">
                    <i class="fas fa-moon" id="light-icon"></i>
                    <input type="checkbox" id="theme-toggle" style="display: none;">
                    <span class="slider" style="display: inline-block; width: 40px; height: 20px; background-color: var(--border-color); border-radius: 10px; position: relative; transition: background-color 0.3s; cursor: pointer;">
                        <span class="toggle-knob" id="theme-knob" style="content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s;"></span>
                    </span>
                    <i class="fas fa-sun" id="dark-icon"></i>
                </label>
                <button class="btn-base btn-cancel" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div id="status-message"></div>

        <div id="loading-overlay">
            <div class="loading-box">
                <div class="loader"></div>
                <p class="font-semibold">Memuat Aplikasi...</p>
            </div>
        </div>

        <div class="main-container">
            
            <section id="dashboard-section" class="content-section">
                <h2 class="text-3xl font-bold mb-8" style="color: var(--text-color);"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard</h2>
                
                <div class="dashboard-grid" id="summary-cards">
                    <div class="dashboard-card" style="background: linear-gradient(145deg, #10b981, #059669);">
                        <i class="dashboard-icon fas fa-users"></i>
                        <h4>Total Pasien Terdaftar</h4>
                        <p id="total-pasien-count">0</p>
                    </div>
                    <div class="dashboard-card" style="background: linear-gradient(145deg, #f59e0b, #d97706);">
                        <i class="dashboard-icon fas fa-heart-circle-check"></i>
                        <h4>Pasien Prolanis (Ya)</h4>
                        <p id="prolanis-count">0</p>
                    </div>
                    <div class="dashboard-card" style="background: linear-gradient(145deg, #3b82f6, #2563eb);">
                        <i class="dashboard-icon fas fa-band-aid"></i>
                        <h4>Pasien PRB (Aktif)</h4>
                        <p id="prb-count">0</p>
                    </div>
                    <div class="dashboard-card" style="background: linear-gradient(145deg, #ef4444, #dc2626);">
                        <i class="dashboard-icon fas fa-diabetes"></i>
                        <h4>Pasien DM</h4>
                        <p id="dm-count">0</p>
                    </div>
                </div>
                
                <div class="card" id="rekap-kunjungan-card">
                    <h3 class="text-xl font-bold mb-6" style="color: var(--text-color);"><i class="fas fa-calendar-alt mr-2"></i> Rekapan Kunjungan Bulanan (Tahun Ini)</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="monthly-recap-table">
                            <thead>
                                <tr>
                                    <th>Bulan</th>
                                    <th>Jumlah Kunjungan</th>
                                    <th>Progress Bar</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-recap-body">
                                <tr><td colspan="3" class="text-center">Memuat data rekapan bulanan...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="exportTableToCSV('monthly-recap-table', 'RekapKunjunganBulanan.csv')" class="btn-base btn-submit shadow-lg">
                            <i class="fas fa-file-excel mr-1"></i> Ekspor Rekapan
                        </button>
                    </div>
                </div>
                
            </section>
            
            <section id="input-form-area" class="content-section active">
                <h3 id="form-title" class="text-3xl font-bold mb-8" style="color: var(--text-color);"><i class="fas fa-notes-medical mr-2"></i> Input Data Kunjungan Pasien Prolanis</h3>
                
                <form id="pasien-input-form">
                    <input type="hidden" id="pasienId" value=""> 
                    
                    <fieldset id="identity-panel">
                        <legend><i class="fas fa-id-card-alt mr-2"></i> Data Identitas Pasien</legend>
                        <p id="patient-status-info" style="font-style: italic; margin-bottom: 20px; color: var(--secondary-color);"></p>
                        <div class="form-grid">
                            <div class="form-group" style="position: relative;">
                                <label for="namaPasien">Nama Pasien</label>
                                <input type="text" id="namaPasien" placeholder="Ketik nama pasien untuk mencari data lama..." required>
                                <div id="search-results-nama" class="search-results"></div>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label for="nik">No. BPJS / NIK (ID Unik)</label>
                                <input type="text" id="nik" placeholder="Ketik NIK/BPJS untuk mencari data lama..." required>
                                <div id="search-results-nik" class="search-results"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="nomorHp">Nomor HP (WA) - Cth: 62812xxxxxx</label>
                                <input type="tel" id="nomorHp" placeholder="Diawali 62, hanya angka" required pattern="62\d{8,15}" title="Diawali 62, minimal 10 angka total">
                            </div>
                            <div class="form-group">
                                <label for="statusProlanis">Status Prolanis</label>
                                <select id="statusProlanis" required>
                                    <option value="Ya">Ya</option>
                                    <option value="Tidak">Tidak</option>
                                    <option value="Perlu Dicek">Perlu Dicek</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="jenisPrb">Jenis PRB</label>
                                <input type="text" id="jenisPrb" placeholder="Contoh: DM, HT, Jantung">
                            </div>
                        </div>
                    </fieldset>
                    
                    <fieldset id="pemeriksaan-panel">
                        <legend><i class="fas fa-stethoscope mr-2"></i> Hasil Pemeriksaan Kunjungan</legend>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="tglKunjungan">Tanggal Kunjungan</label>
                                <input type="date" id="tglKunjungan" value="<?php echo date('Y-m-d'); ?>" required>
                            </div>
                            <div class="form-group">
                                <label for="tdSistole">TD Sistole (mmHg)</label>
                                <input type="number" id="tdSistole" min="1" placeholder="Cth: 120" required>
                            </div>
                            <div class="form-group">
                                <label for="tdDiastole">TD Diastole (mmHg)</label>
                                <input type="number" id="tdDiastole" min="1" placeholder="Cth: 80" required>
                            </div>
                            <div class="form-group">
                                <label for="gulaDarah">Gula Darah (mg/dL)</label>
                                <input type="text" id="gulaDarah" placeholder="Cth: 145, atau '-' jika tidak ada" required>
                            </div>
                            <div class="form-group">
                                <label for="kesadaran">Kesadaran</label>
                                <select id="kesadaran" required>
                                    <option value="Compos Mentis">Compos Mentis</option>
                                    <option value="Apatis">Apatis</option>
                                    <option value="Somnolen">Somnolen</option>
                                    <option value="Sopor">Sopor</option>
                                    <option value="Koma">Koma</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tglObatBerikutnya">Tanggal Obat Berikutnya (DD-MM-YYYY)</label>
                                <input type="text" id="tglObatBerikutnya" 
                                    placeholder="Contoh: 31-12-2024" 
                                    pattern="\d{2}-\d{2}-\d{4}" 
                                    title="Format harus DD-MM-YYYY (contoh: 01-01-2025)" 
                                    required>
                            </div>
                        </div>
                    </fieldset>
                    
                    
                    <div id="form-actions-container" class="flex flex-col">
                        <div id="form-actions" class="flex gap-4 mt-6">
                            <button type="submit" class="btn-base btn-submit" id="submit-button">
                                <i class="fas fa-paper-plane mr-2"></i> Simpan Kunjungan Baru
                            </button>
                            <button type="button" class="btn-base btn-cancel hidden" id="cancel-button" style="width: auto;">
                                <i class="fas fa-times-circle mr-2"></i> Batalkan Edit
                            </button>
                        </div>
                        
                        <p class="save-info-text">
                            <i class="fas fa-save mr-1 text-blue-500"></i> Data ini akan **tersimpan di perangkat Anda** (melalui Local Storage).
                        </p>
                    </div>
                </form>
            </section>
            <section id="rekapan-section" class="content-section">
                
                <h2 id="rekapan-title" class="text-3xl font-bold mb-8" style="color: var(--text-color);"><i class="fas fa-clipboard-list mr-2"></i> Data Kunjungan Terbaru</h2>
                
                <div class="flex gap-3 mb-6">
                    <input type="text" id="search-input-rekapan" placeholder="Cari Nama / NIK Pasien..." class="w-full form-group-input" style="padding:12px; border-radius:10px; border:1px solid var(--border-color);">
                    <button id="search-button-rekapan" class="btn-base btn-submit px-4 w-auto"><i class="fas fa-search"></i> Cari</button>
                </div>

                <div class="table-responsive card p-0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Pasien</th>
                                <th>No. BPJS / NIK</th>
                                <th>TD (mmHg)</th>
                                <th>Gula Darah</th>
                                <th>Tgl. Obat Berikutnya</th>
                                <th>Tgl. Input</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pasien-data-body-rekapan">
                            <tr><td colspan="8" class="text-center">Belum ada data kunjungan.</td></tr>
                        </tbody>
                    </table>
                </div>

            </section>
            
            <section id="daftar-section" class="content-section">
                
                <h2 class="text-3xl font-bold mb-8" style="color: var(--text-color);"><i class="fas fa-user-friends mr-2"></i> Daftar Seluruh Pasien Terdaftar</h2>

                <div class="flex gap-3 mb-6">
                    <input type="text" id="search-input-daftar-all" placeholder="Cari Nama / NIK Pasien..." class="w-full form-group-input" style="padding:12px; border-radius:10px; border:1px solid var(--border-color);">
                    <button id="search-button-daftar-all" class="btn-base btn-submit px-4 w-auto"><i class="fas fa-search"></i> Cari</button>
                </div>

                <div class="table-responsive card p-0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Pasien</th>
                                <th>No. BPJS / NIK</th>
                                <th>Status Prolanis</th>
                                <th>Jenis PRB</th>
                                <th>No. HP</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pasien-data-body-daftar">
                            <tr><td colspan="7" class="text-center">Belum ada data pasien terdaftar.</td></tr>
                        </tbody>
                    </table>
                </div>

            </section>
        </div>
        
    </div>
    
    <div id="duplicate-patient-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--primary-color);"><i class="fas fa-search mr-2"></i> Pasien Sudah Terdaftar!</h3>
            <p>Terdapat Pasien dengan Nama/NIK yang cocok di database:</p>
            <div style="padding: 10px; background: var(--bg-color); border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); text-align: left; color: var(--text-color);">
                <strong>Nama:</strong> <span id="modal-patient-name"></span><br>
                <strong>NIK:</strong> <span id="modal-patient-nik"></span><br>
                <small>ID Master: <span id="modal-patient-id-preview"></span></small>
            </div>
            <p class="font-semibold" style="margin-top: 15px;">Apakah Anda ingin membuat **RIWAYAT KUNJUNGAN BARU** untuk pasien ini?</p>
            <div class="modal-actions">
                <button id="btn-lanjut-lama" class="btn-base btn-submit">
                    <i class="fas fa-check-circle mr-2"></i> Lanjutkan Kunjungan (Tambah Riwayat)
                </button>
                <button id="btn-buat-baru" class="btn-base btn-cancel">
                    <i class="fas fa-user-plus mr-2"></i> Abaikan & Buat Pasien Baru
                </button>
            </div>
        </div>
    </div>

    <div id="delete-pasien-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle mr-2"></i> Konfirmasi Hapus Pasien</h3>
            <p>Anda yakin ingin **menghapus seluruh data pasien** ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="modal-confirm-actions">
                <button class="btn-base btn-cancel" onclick="closeModal('delete-pasien-modal')"><i class="fas fa-times"></i> Batal</button>
                <button class="btn-base btn-delete" id="confirm-delete-pasien-btn"><i class="fas fa-trash-alt mr-2"></i> Hapus Permanen</button>
            </div>
        </div>
    </div>

    <div id="delete-kunjungan-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle mr-2"></i> Konfirmasi Hapus Kunjungan</h3>
            <p>Anda yakin ingin **menghapus data kunjungan** ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="modal-confirm-actions">
                <button class="btn-base btn-cancel" onclick="closeModal('delete-kunjungan-modal')"><i class="fas fa-times"></i> Batal</button>
                <button class="btn-base btn-delete" id="confirm-delete-kunjungan-btn"><i class="fas fa-trash-alt mr-2"></i> Hapus Kunjungan</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // JAVASCRIPT CORE - APLIKASI PROLANIS (VERSI LENGKAP)
        // =================================================================

        // --- A. Inisialisasi Data & Utilitas ---
        const STORAGE_KEY_PASIEN = 'prolanis_data_pasien';
        const STORAGE_KEY_KUNJUNGAN = 'prolanis_data_kunjungan';
        let DB_PASIEN = loadData(STORAGE_KEY_PASIEN) || [];
        let DB_KUNJUNGAN = loadData(STORAGE_KEY_KUNJUNGAN) || [];
        let currentEditPasienId = null;
        let currentEditKunjunganId = null;

        const sections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const statusMessageEl = document.getElementById('status-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const themeToggle = document.getElementById('theme-toggle');
        const themeKnob = document.getElementById('theme-knob');
        
        // Elemen Input
        const namaInput = document.getElementById('namaPasien');
        const nikInput = document.getElementById('nik');
        const resultsNama = document.getElementById('search-results-nama');
        const resultsNik = document.getElementById('search-results-nik');
        
        // --- Utilitas Local Storage ---
        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error("Error loading data from Local Storage:", e);
                return null;
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY_PASIEN, JSON.stringify(DB_PASIEN));
            localStorage.setItem(STORAGE_KEY_KUNJUNGAN, JSON.stringify(DB_KUNJUNGAN));
        }

        function generateUniqueId(prefix) {
            return prefix + Date.now() + Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        // --- Utilitas UI ---
        function showStatus(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `status-message status-${type}`;
            statusMessageEl.style.display = 'block';
            setTimeout(() => {
                statusMessageEl.style.display = 'none';
            }, 5000);
        }

        function showLoading(show = true) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        window.openModal = function(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        window.handleLogout = function() {
             showStatus('Fitur logout akan menghapus sesi. Jika Anda ingin menghapus data, gunakan opsi di Daftar Pasien.', 'warning');
        }

        // --- B. Navigasi & Theme ---
        function switchSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            if (sectionId === 'dashboard-section') updateDashboard();
            if (sectionId === 'rekapan-section') renderKunjunganTable();
            if (sectionId === 'daftar-section') renderDaftarPasien();

            if (sectionId !== 'input-form-area') {
                resetForm();
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.currentTarget.getAttribute('data-section');
                switchSection(sectionId);
            });
        });

        // Dark Mode Logic 
        function applyTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-knob').style.transform = 'translateX(20px)';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('theme-knob').style.transform = 'translateX(2px)';
            }
            themeToggle.checked = isDark;
        }

        themeToggle.addEventListener('change', () => {
            applyTheme(themeToggle.checked);
            localStorage.setItem('prolanis_dark_mode', themeToggle.checked);
        });

        const savedTheme = localStorage.getItem('prolanis_dark_mode');
        if (savedTheme !== null) {
            applyTheme(savedTheme === 'true');
        } else {
            applyTheme(false); 
        }

        // --- C. Dashboard Logic ---
        function updateDashboard() {
            const totalPasien = DB_PASIEN.length;
            const prolanisCount = DB_PASIEN.filter(p => p.statusProlanis === 'Ya').length;
            const prbCount = DB_PASIEN.filter(p => p.jenisPrb && p.jenisPrb.trim() !== '').length;
            const dmCount = DB_PASIEN.filter(p => p.jenisPrb && p.jenisPrb.toUpperCase().includes('DM')).length;

            document.getElementById('total-pasien-count').textContent = totalPasien;
            document.getElementById('prolanis-count').textContent = prolanisCount;
            document.getElementById('prb-count').textContent = prbCount;
            document.getElementById('dm-count').textContent = dmCount;
            
            renderMonthlyRecap();
        }
        
        function renderMonthlyRecap() {
            const recapBody = document.getElementById('monthly-recap-body');
            recapBody.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const monthlyData = {}; 
            
            DB_KUNJUNGAN.forEach(kunjungan => {
                const tglInput = new Date(kunjungan.tglInput);
                if (tglInput.getFullYear() === currentYear) {
                    const month = String(tglInput.getMonth() + 1).padStart(2, '0');
                    monthlyData[month] = (monthlyData[month] || 0) + 1;
                }
            });

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const maxVisits = Math.max(...Object.values(monthlyData), 1); 

            for (let i = 1; i <= 12; i++) {
                const month = String(i).padStart(2, '0');
                const visitCount = monthlyData[month] || 0;
                const monthName = monthNames[i - 1];
                const progressPercent = (visitCount / maxVisits) * 100;    

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthName}</td>
                    <td>${visitCount}</td>
                    <td>
                        <div style="background-color: var(--border-color); border-radius: 10px; overflow: hidden; height: 10px;">
                            <div class="progress-bar-fill" style="width: ${progressPercent}%; height: 100%; background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); transition: width 0.5s ease;"></div>
                        </div>
                    </td>
                `;
                recapBody.appendChild(row);
            }
        }

        // --- D. Form Input/Edit Logic & Duplikasi Riwayat ---
        function resetForm() {
            document.getElementById('pasien-input-form').reset();
            document.getElementById('pasienId').value = '';
            document.getElementById('form-title').innerHTML = '<i class="fas fa-notes-medical mr-2"></i> Input Data Kunjungan Pasien Prolanis';
            document.getElementById('submit-button').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Simpan Kunjungan Baru';
            document.getElementById('cancel-button').classList.add('hidden');
            document.getElementById('patient-status-info').textContent = '';
            // Set tanggal kunjungan hari ini
            document.getElementById('tglKunjungan').value = new Date().toISOString().split('T')[0];
            currentEditPasienId = null;
            currentEditKunjunganId = null;
            clearAutocompleteResults();
            // Re-enable semua input IDENTITAS
            document.querySelectorAll('#identity-panel input, #identity-panel select').forEach(el => el.disabled = false);
        }
        
        document.getElementById('pasien-input-form').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading();
            setTimeout(() => { 
                handleSubmitKunjungan();
            }, 500);
        });

        document.getElementById('cancel-button').addEventListener('click', resetForm);

        function handleSubmitKunjungan() {
            const isEditKunjungan = !!currentEditKunjunganId;
            const idPasien = document.getElementById('pasienId').value || generateUniqueId('PASIEN');
            
            const tglInput = new Date().toISOString(); 
            const tglKunjungan = document.getElementById('tglKunjungan').value;

            // 1. Ambil/Update Data Pasien (MASTER)
            let pasienIndex = DB_PASIEN.findIndex(p => p.id === idPasien);
            let pasienData;

            if (pasienIndex === -1) {
                // Pasien Baru
                pasienData = {
                    id: idPasien,
                    nama: namaInput.value.trim(),
                    nik: nikInput.value.trim(),
                    nomorHp: document.getElementById('nomorHp').value.trim(),
                    statusProlanis: document.getElementById('statusProlanis').value,
                    jenisPrb: document.getElementById('jenisPrb').value.trim(),
                };
                DB_PASIEN.push(pasienData);
            } else {
                // Pasien Lama: Update Data Master (jika ada perubahan di mode EditPasien)
                pasienData = DB_PASIEN[pasienIndex];
                pasienData.nama = namaInput.value.trim();
                pasienData.nik = nikInput.value.trim();
                pasienData.nomorHp = document.getElementById('nomorHp').value.trim();
                pasienData.statusProlanis = document.getElementById('statusProlanis').value;
                pasienData.jenisPrb = document.getElementById('jenisPrb').value.trim();
            }
            
            // 2. Buat data Kunjungan (RIWAYAT BARU atau UPDATE RIWAYAT LAMA)
            const newKunjungan = {
                id: isEditKunjungan ? currentEditKunjunganId : generateUniqueId('KUNJUNGAN'),
                pasienId: idPasien, 
                tglKunjungan: tglKunjungan, 
                tdSistole: parseInt(document.getElementById('tdSistole').value),
                tdDiastole: parseInt(document.getElementById('tdDiastole').value),
                gulaDarah: document.getElementById('gulaDarah').value.trim(),
                kesadaran: document.getElementById('kesadaran').value,
                tglObatBerikutnya: document.getElementById('tglObatBerikutnya').value,
                tglInput: tglInput, // **WAKTU PENGINPUTAN**
            };

            if (isEditKunjungan) {
                const kunjunganIndex = DB_KUNJUNGAN.findIndex(k => k.id === currentEditKunjunganId);
                if (kunjunganIndex !== -1) {
                    DB_KUNJUNGAN[kunjunganIndex] = newKunjungan;
                }
            } else {
                // Menambah riwayat baru
                DB_KUNJUNGAN.push(newKunjungan);
            }

            saveData();
            showStatus(isEditKunjungan ? 'Data kunjungan berhasil diperbarui.' : 'Data kunjungan berhasil disimpan!', 'success');
            resetForm();
            updateDashboard();
            switchSection('rekapan-section'); 
            showLoading(false);
        }

        // --- E. Autocomplete, Pengecekan Duplikasi & Load Data ---

        function clearAutocompleteResults() {
            resultsNama.innerHTML = '';
            resultsNik.innerHTML = '';
        }

        // Fungsi untuk memuat data pasien (dipicu dari modal/autocomplete)
        window.loadPatientData = function(pasienId, sourceInputId) {
            const patient = DB_PASIEN.find(p => p.id === pasienId);
            if (!patient) return;

            showLoading();
            setTimeout(() => {
                resetForm(); 
                currentEditPasienId = pasienId;
                
                // 1. Isi Form Identitas (Data Master Pasien)
                document.getElementById('pasienId').value = pasienId;
                document.getElementById('namaPasien').value = patient.nama;
                document.getElementById('nik').value = patient.nik;
                document.getElementById('nomorHp').value = patient.nomorHp;
                document.getElementById('statusProlanis').value = patient.statusProlanis;
                document.getElementById('jenisPrb').value = patient.jenisPrb;

                // 2. Kunci Kolom Identitas agar hanya menginput riwayat baru
                document.querySelectorAll('#identity-panel input, #identity-panel select').forEach(el => el.disabled = true);

                // 3. Update UI
                document.getElementById('form-title').innerHTML = `<i class="fas fa-plus mr-2"></i> Kunjungan Baru untuk ${patient.nama}`;
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-edit mr-2"></i> Simpan RIWAYAT Kunjungan Terbaru';
                document.getElementById('cancel-button').classList.remove('hidden');
                document.getElementById('patient-status-info').textContent = `Pasien ditemukan. Anda akan menambahkan RIWAYAT kunjungan baru.`;
                
                document.getElementById('tdSistole').focus();
                clearAutocompleteResults();
                showLoading(false);
                showStatus('Data pasien ditemukan. Silakan isi data pemeriksaan untuk riwayat baru.', 'info');
            }, 100);
        }

        // Fungsi untuk memicu Modal Konfirmasi jika Pasien Ditemukan (Duplikasi)
        function checkAndOpenDuplicateModal() {
            const nama = namaInput.value.trim();
            const nik = nikInput.value.trim();
            
            clearAutocompleteResults(); 

            // Tidak perlu cek jika Pasien ID sudah terisi (berarti sedang mode edit)
            if ((!nama && !nik) || document.getElementById('pasienId').value) return; 

            let matchingPatient = null;
            
            // Prioritas 1: Cek NIK (Harus sama persis)
            if (nik && nik.length >= 10) {
                matchingPatient = DB_PASIEN.find(p => p.nik === nik && p.nik !== "");
            }

            // Prioritas 2: Cek Nama (Jika NIK tidak cocok)
            if (!matchingPatient && nama && nama.length > 3) {
                matchingPatient = DB_PASIEN.find(p => p.nama.toLowerCase() === nama.toLowerCase());
            }

            if (matchingPatient) {
                // Tampilkan Modal Kecil/Pilihan
                document.getElementById('modal-patient-name').textContent = matchingPatient.nama;
                document.getElementById('modal-patient-nik').textContent = matchingPatient.nik || 'N/A';
                document.getElementById('modal-patient-id-preview').textContent = matchingPatient.id.substring(0, 8) + '...';
                
                // Lanjutkan Kunjungan (Tambah Riwayat)
                document.getElementById('btn-lanjut-lama').onclick = () => {
                    closeModal('duplicate-patient-modal');
                    loadPatientData(matchingPatient.id, 'nik'); 
                };

                // Abaikan & Buat Baru
                document.getElementById('btn-buat-baru').onclick = () => {
                    closeModal('duplicate-patient-modal');
                    resetForm(); 
                    namaInput.value = nama;
                    nikInput.value = nik;
                    document.getElementById('patient-status-info').textContent = `Anda memilih membuat data baru. ID Pasien baru akan dibuat saat disimpan.`;
                    showStatus('Mode Pasien BARU diaktifkan.', 'warning');
                };

                openModal('duplicate-patient-modal');
            } 
        }
        
        // Fungsi Autocomplete generik (menampilkan dropdown)
        function handleSearchInput(inputEl, resultsEl, keyField) {
            const query = inputEl.value.trim();
            resultsEl.innerHTML = ''; // Hapus hasil lama

            if (query.length > 2) {
                const filtered = DB_PASIEN.filter(p => p[keyField].toLowerCase().includes(query.toLowerCase()));
                if (filtered.length > 0) {
                    filtered.slice(0, 5).forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerHTML = `
                            <span>${p.nama} (${p.nik})</span>
                            <span class="search-item-info">ID: ${p.id.substring(0, 8)}</span>
                        `;
                        item.addEventListener('click', () => loadPatientData(p.id, inputEl.id));
                        resultsEl.appendChild(item);
                    });
                }
            }
        }

        // Event listener utama untuk memicu pencarian dan modal
        namaInput.addEventListener('input', () => {
            handleSearchInput(namaInput, resultsNama, 'nama');
            checkAndOpenDuplicateModal(); 
        });
        
        nikInput.addEventListener('input', () => {
            handleSearchInput(nikInput, resultsNik, 'nik');
            checkAndOpenDuplicateModal();
        });


        // --- F. Tabel Display & Aksi ---
        
        window.getKunjunganRow = function(kunjungan, index, patient) {
            const tdStyle = 'font-size: 0.9rem;';
            const tglKunjunganFormatted = new Date(kunjungan.tglKunjungan).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});

            return `
                <tr data-kunjungan-id="${kunjungan.id}" data-pasien-id="${kunjungan.pasienId}">
                    <td style="${tdStyle}">${index + 1}</td>
                    <td style="${tdStyle}">${patient ? patient.nama : 'N/A'}</td>
                    <td style="${tdStyle}">${patient ? patient.nik : 'N/A'}</td>
                    <td style="${tdStyle}">${kunjungan.tdSistole}/${kunjungan.tdDiastole}</td>
                    <td style="${tdStyle}">${kunjungan.gulaDarah}</td>
                    <td style="${tdStyle}">${kunjungan.tglObatBerikutnya || '-'}</td>
                    <td style="${tdStyle}">${new Date(kunjungan.tglInput).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'})} ${new Date(kunjungan.tglInput).toLocaleTimeString('id-ID')}</td>
                    <td style="${tdStyle}">
                        <div class="flex gap-2">
                            <button class="btn-base btn-detail btn-aksi" onclick="editKunjungan('${kunjungan.id}')" title="Edit Kunjungan"><i class="fas fa-edit"></i></button>
                            <button class="btn-base btn-delete-pasien btn-aksi" onclick="promptDeleteKunjungan('${kunjungan.id}')" title="Hapus Kunjungan"><i class="fas fa-trash-alt"></i></button>
                            <button class="btn-base btn-whatsapp btn-aksi" onclick="sendWhatsApp('${patient.nomorHp || ''}', '${patient.nama || ''}', '${kunjungan.id}')" title="Kirim WA Pengingat"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }

        window.getPasienRow = function(pasien, index) {
            const tdStyle = 'font-size: 0.9rem;';
            const statusClass = pasien.statusProlanis === 'Ya' ? 'text-green-500 font-semibold' : (pasien.statusProlanis === 'Perlu Dicek' ? 'text-yellow-500' : 'text-red-500');
            return `
                <tr data-pasien-id="${pasien.id}">
                    <td style="${tdStyle}">${index + 1}</td>
                    <td style="${tdStyle}">${pasien.nama}</td>
                    <td style="${tdStyle}">${pasien.nik}</td>
                    <td style="${tdStyle} ${statusClass}">${pasien.statusProlanis}</td>
                    <td style="${tdStyle}">${pasien.jenisPrb || '-'}</td>
                    <td style="${tdStyle}">${pasien.nomorHp || '-'}</td>
                    <td style="${tdStyle}">
                        <div class="flex gap-2">
                            <button class="btn-base btn-detail btn-aksi" onclick="editPasien('${pasien.id}')" title="Edit Data Master"><i class="fas fa-edit"></i></button>
                            <button class="btn-base btn-delete-pasien btn-aksi" onclick="promptDeletePasien('${pasien.id}')" title="Hapus Pasien Permanen"><i class="fas fa-trash-alt"></i></button>
                            <button class="btn-base btn-riwayat btn-aksi" onclick="showPatientHistory('${pasien.id}')" title="Lihat Riwayat Kunjungan"><i class="fas fa-history"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderKunjunganTable(filterFn = () => true) {
            const tbody = document.getElementById('pasien-data-body-rekapan');
            tbody.innerHTML = '';
            
            const filteredKunjungan = DB_KUNJUNGAN
                .filter(filterFn)
                .sort((a, b) => new Date(b.tglInput) - new Date(a.tglInput)); 

            if (filteredKunjungan.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada data kunjungan yang cocok.</td></tr>';
                return;
            }

            filteredKunjungan.forEach((kunjungan, index) => {
                const patient = DB_PASIEN.find(p => p.id === kunjungan.pasienId);
                if (patient) {
                    tbody.innerHTML += getKunjunganRow(kunjungan, index, patient);
                }
            });
        }

        function renderDaftarPasien(filterFn = () => true) {
            const tbody = document.getElementById('pasien-data-body-daftar');
            tbody.innerHTML = '';

            const filteredPasien = DB_PASIEN
                .filter(filterFn)
                .sort((a, b) => a.nama.localeCompare(b.nama));

            if (filteredPasien.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data pasien yang cocok.</td></tr>';
                return;
            }

            filteredPasien.forEach((pasien, index) => {
                tbody.innerHTML += getPasienRow(pasien, index);
            });
        }

        // --- G. Aksi CRUD/Utility ---

        window.editPasien = function(pasienId) {
            const patient = DB_PASIEN.find(p => p.id === pasienId);
            if (!patient) return showStatus('Pasien tidak ditemukan!', 'error');

            showLoading();
            setTimeout(() => {
                switchSection('input-form-area');
                
                document.getElementById('pasienId').value = patient.id;
                document.getElementById('namaPasien').value = patient.nama;
                document.getElementById('nik').value = patient.nik;
                document.getElementById('nomorHp').value = patient.nomorHp;
                document.getElementById('statusProlanis').value = patient.statusProlanis;
                document.getElementById('jenisPrb').value = patient.jenisPrb;
                document.getElementById('tglKunjungan').value = new Date().toISOString().split('T')[0];

                document.querySelectorAll('#identity-panel input, #identity-panel select').forEach(el => el.disabled = false);

                document.getElementById('form-title').innerHTML = `<i class="fas fa-user-edit mr-2"></i> Edit Data Master Pasien ${patient.nama}`;
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-save mr-2"></i> Update Data Pasien & Tambah Kunjungan';
                document.getElementById('cancel-button').classList.remove('hidden');
                document.getElementById('patient-status-info').textContent = `Anda mengedit data MASTER pasien. Kunjungan baru akan ditambahkan setelah submit.`;
                
                showLoading(false);
            }, 100);
        }

        window.editKunjungan = function(kunjunganId) {
            const kunjungan = DB_KUNJUNGAN.find(k => k.id === kunjunganId);
            const patient = DB_PASIEN.find(p => p.id === kunjungan.pasienId);
            if (!kunjungan || !patient) return showStatus('Data kunjungan/pasien tidak ditemukan!', 'error');

            showLoading();
            setTimeout(() => {
                resetForm();
                switchSection('input-form-area');
                
                currentEditKunjunganId = kunjunganId;
                document.getElementById('pasienId').value = patient.id;
                document.getElementById('tdSistole').value = kunjungan.tdSistole;
                document.getElementById('tdDiastole').value = kunjungan.tdDiastole;
                document.getElementById('gulaDarah').value = kunjungan.gulaDarah;
                document.getElementById('kesadaran').value = kunjungan.kesadaran;
                document.getElementById('tglObatBerikutnya').value = kunjungan.tglObatBerikutnya;
                document.getElementById('tglKunjungan').value = kunjungan.tglKunjungan;
                
                document.getElementById('namaPasien').value = patient.nama;
                document.getElementById('nik').value = patient.nik;
                document.getElementById('nomorHp').value = patient.nomorHp;
                document.getElementById('statusProlanis').value = patient.statusProlanis;
                document.getElementById('jenisPrb').value = patient.jenisPrb;

                document.getElementById('form-title').innerHTML = `<i class="fas fa-edit mr-2"></i> Edit Kunjungan Tanggal ${kunjungan.tglKunjungan} (${patient.nama})`;
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-save mr-2"></i> Update Data Kunjungan';
                document.getElementById('cancel-button').classList.remove('hidden');
                document.getElementById('patient-status-info').textContent = `Anda sedang mengedit data kunjungan lama, bukan data master pasien.`;

                document.querySelectorAll('#identity-panel input, #identity-panel select').forEach(el => el.disabled = true);
                document.getElementById('pemeriksaan-panel').querySelector('input[type="number"]').focus();
                
                showLoading(false);
                showStatus('Siap mengedit data kunjungan.', 'info');
            }, 100);
        }

        window.showPatientHistory = function(pasienId) {
            const patient = DB_PASIEN.find(p => p.id === pasienId);
            if (!patient) return;

            switchSection('rekapan-section');
            document.getElementById('rekapan-title').textContent = `Rekap Riwayat Kunjungan: ${patient.nama} (${patient.nik})`;

            renderKunjunganTable(k => k.pasienId === pasienId);
            
            document.getElementById('search-input-rekapan').value = patient.nama;
            document.getElementById('search-button-rekapan').onclick = () => {
                document.getElementById('rekapan-title').textContent = 'Data Kunjungan Terbaru';
                document.getElementById('search-input-rekapan').value = '';
                renderKunjunganTable();
            };
        }

        window.promptDeletePasien = function(pasienId) {
            closeModal('delete-kunjungan-modal');
            document.getElementById('confirm-delete-pasien-btn').onclick = () => deletePasien(pasienId);
            openModal('delete-pasien-modal');
        }

        function deletePasien(pasienId) {
            showLoading();
            setTimeout(() => {
                const nama = DB_PASIEN.find(p => p.id === pasienId)?.nama || 'Pasien';
                DB_KUNJUNGAN = DB_KUNJUNGAN.filter(k => k.pasienId !== pasienId);
                DB_PASIEN = DB_PASIEN.filter(p => p.id !== pasienId);

                saveData();
                closeModal('delete-pasien-modal');
                showStatus(`Data ${nama} dan semua kunjungannya berhasil dihapus.`, 'success');
                updateDashboard();
                renderDaftarPasien();
                showLoading(false);
            }, 500);
        }

        window.promptDeleteKunjungan = function(kunjunganId) {
            closeModal('delete-pasien-modal');
            document.getElementById('confirm-delete-kunjungan-btn').onclick = () => deleteKunjungan(kunjunganId);
            openModal('delete-kunjungan-modal');
        }

        function deleteKunjungan(kunjunganId) {
            showLoading();
            setTimeout(() => {
                const kunjunganIndex = DB_KUNJUNGAN.findIndex(k => k.id === kunjunganId);
                if (kunjunganIndex !== -1) {
                    const namaPasien = DB_PASIEN.find(p => p.id === DB_KUNJUNGAN[kunjunganIndex].pasienId)?.nama || 'Pasien';
                    DB_KUNJUNGAN.splice(kunjunganIndex, 1);
                    saveData();
                    closeModal('delete-kunjungan-modal');
                    showStatus(`Data kunjungan untuk ${namaPasien} berhasil dihapus.`, 'success');
                } else {
                    showStatus('Data kunjungan tidak ditemukan.', 'error');
                }
                updateDashboard();
                renderKunjunganTable();
                showLoading(false);
            }, 500);
        }
        
        window.sendWhatsApp = function(phoneNumber, patientName, kunjunganId) {
            const kunjungan = DB_KUNJUNGAN.find(k => k.id === kunjunganId);
            if (!phoneNumber || !kunjungan) return showStatus('Nomor HP atau data kunjungan pasien tidak ditemukan.', 'error');
            
            const message = `Yth. Bapak/Ibu ${patientName},
Ini adalah pengingat jadwal kontrol Prolanis/PRB Anda.
Detail Kunjungan Terakhir (${new Date(kunjungan.tglKunjungan).toLocaleDateString('id-ID')}):
- TD: ${kunjungan.tdSistole}/${kunjungan.tdDiastole} mmHg
- Gula Darah: ${kunjungan.gulaDarah} mg/dL
- Obat Berikutnya: ${kunjungan.tglObatBerikutnya}

Silakan konfirmasi kehadiran Anda. Terima kasih.
(Pesan otomatis dari Klinik)`;
            
            const cleanPhoneNumber = phoneNumber.replace(/[^0-9]/g, '');
            const encodedMessage = encodeURIComponent(message);
            const waLink = `https://wa.me/${cleanPhoneNumber}?text=${encodedMessage}`;
            
            window.open(waLink, '_blank');
        }

        document.getElementById('search-button-rekapan').addEventListener('click', () => {
            const query = document.getElementById('search-input-rekapan').value.toLowerCase();
            document.getElementById('rekapan-title').textContent = `Rekap Kunjungan (Filter: ${query || 'Semua'})`;
            renderKunjunganTable(k => {
                const patient = DB_PASIEN.find(p => p.id === k.pasienId);
                return patient && (patient.nama.toLowerCase().includes(query) || patient.nik.toLowerCase().includes(query));
            });
        });

        document.getElementById('search-button-daftar-all').addEventListener('click', () => {
            const query = document.getElementById('search-input-daftar-all').value.toLowerCase();
            renderDaftarPasien(p => p.nama.toLowerCase().includes(query) || p.nik.toLowerCase().includes(query));
        });

        window.exportTableToCSV = function(tableId, filename) {
            var table = document.getElementById(tableId) || document.querySelector('.data-table'); 
            var csv = [];
            var rows = table.querySelectorAll("thead tr, tbody tr");
            
            for (var i = 0; i < rows.length; i++) {
                var row = [], cells = rows[i].querySelectorAll("th, td");
                for (var j = 0; j < cells.length; j++) {
                    var cellText = cells[j].innerText.trim();
                    // Hapus kolom Aksi (kolom terakhir)
                    if (i > 0 && j === cells.length - 1) continue; 
                    if (i === 0 && cellText.toLowerCase() === 'aksi') continue;
                    
                    var value = cellText.replace(/,/g, ";");    
                    row.push('"' + value + '"');
                }
                if (row.length > 0) { // Pastikan baris tidak kosong setelah kolom Aksi dihapus
                    csv.push(row.join(","));          
                }
            }
            
            var csvFile = new Blob([csv.join("\n")], {type: 'text/csv'});
            var downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = URL.createObjectURL(csvFile);
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            showStatus('File CSV berhasil diunduh.', 'success');
        }

        // --- I. Inisialisasi Aplikasi ---
        function initializeApp() {
            showLoading();
            
            setTimeout(() => {
                // Data dummy (Jika kosong)
                if (DB_PASIEN.length === 0) {
                    const id1 = generateUniqueId('PASIEN');
                    const id2 = generateUniqueId('PASIEN');
                    
                    DB_PASIEN = [
                        { id: id1, nama: 'Ahmad Budi Santoso', nik: '3201011234567890', nomorHp: '6281234567890', statusProlanis: 'Ya', jenisPrb: 'DM' },
                        { id: id2, nama: 'Siti Aminah', nik: '3171098765432109', nomorHp: '6285700001111', statusProlanis: 'Ya', jenisPrb: 'HT' },
                    ];
                    DB_KUNJUNGAN = [
                        { id: generateUniqueId('KUNJUNGAN'), pasienId: id1, tglKunjungan: '2024-10-01', tdSistole: 145, tdDiastole: 92, gulaDarah: '190', kesadaran: 'Compos Mentis', tglObatBerikutnya: '15-11-2024', tglInput: new Date('2024-10-01T10:00:00Z').toISOString() },
                        { id: generateUniqueId('KUNJUNGAN'), pasienId: id2, tglKunjungan: '2024-10-05', tdSistole: 130, tdDiastole: 80, gulaDarah: '-', kesadaran: 'Compos Mentis', tglObatBerikutnya: '05-11-2024', tglInput: new Date('2024-10-05T11:30:00Z').toISOString() },
                        { id: generateUniqueId('KUNJUNGAN'), pasienId: id1, tglKunjungan: '2024-10-20', tdSistole: 135, tdDiastole: 85, gulaDarah: '165', kesadaran: 'Compos Mentis', tglObatBerikutnya: '20-11-2024', tglInput: new Date('2024-10-20T14:45:00Z').toISOString() },
                    ];
                    saveData();
                    showStatus('Data awal (dummy) dimuat. (Hanya muncul jika Local Storage kosong)', 'info');
                }
                
                updateDashboard();
                showLoading(false);
                switchSection('input-form-area'); // Tetap di Input Baru setelah loading
                resetForm(); // Pastikan form bersih dan siap
            }, 1500); 
        }
        
        initializeApp();
    </script>
</body>
</html>
